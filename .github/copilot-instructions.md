# PBL-Perpustakaan â€” AI Agent Guide

> **BookEZ**: Room booking system for Politeknik Negeri Jakarta. Plain PHP + Tailwind CSS, XAMPP/Apache server, query-string routing (no framework), traditional server-side rendering.

## ðŸš€ Quick Start (Read This First!)

**What is this?** Room booking system with user/admin/super-admin roles, violation tracking, operational hours management.

**Tech Stack:** PHP 8.x + MySQL + Tailwind CSS 4.1.16 + XAMPP + vanilla JavaScript (NO frameworks)

**Critical Patterns:**
- **Routing:** `/index.php?page={controller}&action={method}` â†’ `{Controller}::{method}()` 
- **Add Route:** Update `index.php` autoloader + switch case **WITH `break;`!** (missing = fallthrough to home)
- **Build CSS:** `npm run watch:css` (dev) or `npm run build:css` (prod) â€” edits go in `input.css` NOT `main.css`
- **No inline JS/CSS:** Everything in external files under `assets/js/` and `assets/css/`
- **Data to JS:** Use hidden `<div>` with `data-*` attributes, NOT inline `<script>` blocks
- **AJAX Usage:** Allowed for dynamic features (use `fetch()` API, return JSON with `{success, data, message}` structure)
- **Auth:** `$_SESSION['user']['role']` = `'User'|'Admin'|'Super Admin'` â€” validate in BOTH controller AND view
- **Testing:** All test files go in `temp/` folder (never in controller/model/view/)

**Before Coding:**
1. Apache + MySQL running in XAMPP
2. Database `PBL-Perpustakaan` exists (`sql/database.sql`)
3. `npm install` completed
4. `npm run watch:css` running if editing styles
5. Check `temp/IMPLEMENTASI_*.md` and `temp/BUGFIX_*.md` for feature patterns

**Most Common Tasks:** Add page (see Template 1), add modal (Template 2), add pagination (Template 3), test feature (`temp/test_*.php`).

## ðŸ§­ Navigation Guide â€” Find What You Need Fast

**I need to...**
- **Add a new feature/page** â†’ See "Routing & Controllers" + "Code Generation Templates" (Template 1)
- **Understand the architecture** â†’ "Architecture Overview" + "Database Schema Quick Reference"
- **Fix routing issues** â†’ "Routing & Controllers" + "Critical Anti-Patterns" (missing `break;`)
- **Work with sessions/auth** â†’ "Session & Authentication" + "Page Guards & Access Control"
- **Build/watch CSS** â†’ "Tailwind Build" section
- **Add JavaScript functionality** â†’ "JavaScript Separation of Concerns" (NO inline scripts!)
- **Handle file uploads** â†’ "File Upload Handling" section
- **Add pagination** â†’ "Pagination Pattern" + Template 3
- **Send emails** â†’ "Email Configuration" + "Email Notifications"
- **Work with bookings** â†’ "Booking Lifecycle & Business Rules" + "Automated Status Updates"
- **Debug an issue** â†’ Check `temp/BUGFIX_*.md` files + "Troubleshooting Common Issues"
- **Test a feature** â†’ "Test Scripts (`temp/test_*.php`)" section
- **Understand database schema** â†’ "Database Setup" + "Database Schema Quick Reference"
- **Add admin features** â†’ "Admin Area Structure" + "Wired Pages" (admin routes)
- **Configure operational hours** â†’ "Operational Hours & Holidays System"

---

## Quick Reference â€” Most Common Tasks
**Add new page:** Update `index.php` autoloader + switch case (with `break;`!) + create controller/model  
**Build CSS:** `npm run watch:css` (dev auto-rebuild) or `npm run build:css` (production minified)  
**Test features:** Use `temp/test_*.php` scripts (email, session, queries, etc.)  
**Debug issues:** Check `temp/debug_*.php` and `temp/BUGFIX_*.md` for known solutions  
**Implementation guides:** See `temp/IMPLEMENTASI_*.md` for feature patterns  
**Routes:** `/index.php?page={controller}&action={method}` (e.g., `?page=booking&action=buat_booking`)  
**AJAX endpoints:** `?page=booking&action=get_user_by_nim&nim={nim}` returns JSON `{success, data, message}`  

## Quick Start Checklist
Before making changes, verify:
1. âœ… Apache + MySQL running in XAMPP control panel
2. âœ… `npm install` completed (for Tailwind CSS build tools)
3. âœ… Database `PBL-Perpustakaan` exists with schema from `sql/database.sql`
4. âœ… Run `npm run watch:css` in terminal if editing styles
5. âœ… Test at `http://localhost/` (or subfolder path)

**Common Commands (PowerShell):**
```powershell
npm run watch:css              # Watch Tailwind CSS during development
npm run build:css              # Build minified CSS for production
```

**Critical Files to Never Manually Edit:**
- `assets/css/main.css` â€” auto-generated by Tailwind (edit `input.css` instead)
- `config/Koneksi.php` â€” contains credentials (use `koneksi.example.php` as template)

## Architecture Overview
Plain PHP + Tailwind CSS room booking system (BookEZ) served by Apache/XAMPP. No framework or SPA routerâ€”traditional server-side rendering with query-string routing.

**Entry point:** `index.php` orchestrates everything:
- Starts session globally (`session_start()` with safety check using `session_status()`)
- Manual class autoloader via `spl_autoload_register()` using `$mapmodeldancontroller` array
- Routes via `$_GET['page']` (controller) and `$_GET['action']` (method) to controller methods
- Default: `page=home` renders `view/startpage.php` directly (no controller)
- Example: `/index.php?page=login&action=index` â†’ `LoginController::index()`
- 404 renders `view/error.php` when controller method doesn't exist (checks with `method_exists()`)
- **Note:** GuestController exists in autoloader but is deprecated/unused

**Critical:** When adding features, update BOTH:
1. `$mapmodeldancontroller` array (class name â†’ file path mapping)
2. `switch ($halaman)` block (instantiate controller for the page)
3. **Missing `break;` statement will cause default fallthrough to home page!**

**Database connection:** `config/Koneksi.php` uses Singleton pattern, provides `$pdo` globally via `Koneksi::getConnection()`. PDO modes: `ERRMODE_EXCEPTION`, `FETCH_ASSOC`, charset `utf8mb4`. Backward compatible `$pdo` variable available after including config.

**Configuration:** Database credentials in `config/Koneksi.php`:
- Host: `127.0.0.1`, Database: `PBL-Perpustakaan`
- Default: User: `root`, Password: `admin` (environment-specific)
- **Never commit real credentials** â€” use `config/koneksi.example.php` as template for new environments

## Wired Pages
Current routes: `login`, `register`, `booking`, `dashboard`, `profile`, `admin`

**User routes:**
- `booking&action=index` â†’ booking list view
- `booking&action=buat_booking` â†’ create new booking
- `booking&action=kode_booking` â†’ booking confirmation
- `booking&action=hapus_booking` â†’ delete booking
- `booking&action=reschedule` â†’ reschedule request (view: reskedul_booking.php)
- `booking&action=get_user_by_nim` â†’ AJAX endpoint for user lookup
- `dashboard&action=index` â†’ user dashboard (redirects admins to admin dashboard)
- `profile&action=index` â†’ user profile/settings
- `feedback` (page only) â†’ post-booking feedback form (view/feedback.php)

**Admin routes:** Protected by role check in `AdminController.__construct()`:
- `admin&action=index` â†’ admin dashboard (view/admin/dashboard.php)
- `admin&action=kelola_ruangan` â†’ manage rooms (CRUD operations)
- `admin&action=laporan` â†’ reports and analytics
- `admin&action=booking_list` â†’ booking list with check-in management
- `admin&action=member_list` â†’ user/admin management (view/edit/add/delete)
- `admin&action=booking_external` â†’ external bookings (Super Admin only)
- `admin&action=pengaturan` â†’ system settings: operational hours & holidays (Super Admin only)

## View & Asset Patterns
**Head component:** All views start with this exact pattern:
```php
<?php require __DIR__ . '/components/head.php'; ?>
<title>Your Page Title</title>
</head>
```

`view/components/head.php` computes `$basePath` from document root using filesystem path normalization and exposes `$asset()` helper as an anonymous function:
```php
$asset('assets/css/main.css')           // â†’ /assets/css/main.css (or /subfolder/assets/css/main.css)
$asset('view/components/captcha.php')   // works for dynamic endpoints too
$asset('/assets/image/logo.png')        // leading slash OK, auto-normalized
```
The helper handles both XAMPP root deploys and subfolder deploys automatically.

**CSS:** `assets/css/input.css` (Tailwind source) â†’ `assets/css/main.css` (generated, auto-linked by head)  
**Build:** `npm run watch:css` (dev) or `npm run build:css` (production minified)  
**JS:** Lives in `assets/js/`, reference via `$asset('assets/js/captcha.js')`, use `defer` attribute for non-blocking load

## Database Setup
- **Config:** `config/Koneksi.php` provides `$pdo` (PDO instance) for MySQL connection
  - Host: `127.0.0.1`, DB: `PBL-Perpustakaan`
  - Default credentials: User: `root`, Pass: `admin` (may vary per environment)
  - PDO modes: `ERRMODE_EXCEPTION`, `FETCH_ASSOC`, charset: `utf8mb4`
- **Schema & Data:** `sql/database.sql` contains BOTH schema definition AND dummy data in single file
  - Uses transaction-based setup with CREATE DATABASE, table definitions, and INSERT statements
  - Main tables: `akun`, `ruangan`, `booking`, `anggota_booking`, `schedule`, `feedback`, `pelanggaran_suspensi`, `status_booking`
  - Engine: InnoDB, Collation: `utf8mb4_general_ci` (tables), `utf8mb4_0900_ai_ci` (database)
  - Includes test data: 13 rooms, 7 accounts (2 admins, 5 users), sample bookings and feedback
  - Each column documented with COMMENT describing its purpose and constraints
- **Deployment:** Run `sql/database.sql` once to setup complete database with test data
- **Implementation Status:** Database connected and ready. Models existâ€”gradually replacing mock data with DB queries as features are implemented

## Session & Authentication
- **User session:** `$_SESSION['user']` stores authenticated user data
- **Required keys:** `$_SESSION['user']['role']` (values: `'User'`, `'Admin'`, `'Super Admin'`)
  - Legacy roles: `'Mahasiswa'`, `'Dosen'`, `'Tenaga Pendidikan'` (deprecated, use `'User'` for new registrations)
- **Session data structure:**
  ```php
  $_SESSION['user'] = [
      'nomor_induk' => string,           // NIM/NIP
      'username' => string,              // Display name
      'email' => string,
      'role' => string,                  // 'User', 'Admin', or 'Super Admin'
      'status' => string,                // 'Aktif' or 'Tidak Aktif'
      'jurusan' => string|null,          // Only for Mahasiswa (User with jurusan)
      'prodi' => string|null,            // Only for Mahasiswa (User with prodi)
      'foto_profil' => string|null,      // Path to profile photo in assets/uploads/images/
      'validasi_mahasiswa' => string|null // Path to screenshot KubacaPNJ for validation
  ];
  ```
- **Password Policy:** Minimum 8 characters enforced during registration/account creation
- **Email Domain Validation:** CRITICAL - All emails must use PNJ domain
    - **Mahasiswa/User:** `*@stu.pnj.ac.id` (contoh: `nama@stu.pnj.ac.id`, `nama.nim@stu.pnj.ac.id` â€” local-part fleksibel)
    - Examples: `maulana.ibrahim.a@stu.pnj.ac.id`, `budi.santoso.1@stu.pnj.ac.id`
  - **Dosen/Admin/Staff:** `nama@jurusan.pnj.ac.id` or `nama@pnj.ac.id` (NOT @stu.pnj.ac.id)
    - Examples: `euis.oktavianti@tik.pnj.ac.id`, `admin@pnj.ac.id`
  - **Validation Pattern (PHP):**
    ```php
    // Mahasiswa: harus @stu.pnj.ac.id dengan format nama.x@
    preg_match('/^[a-zA-Z0-9._%+-]+\\.[a-zA-Z0-9]@stu\\.pnj\\.ac\\.id$/', $email)
    
    // Dosen/Admin: harus @*.pnj.ac.id atau @pnj.ac.id (bukan @stu.pnj.ac.id)
    (preg_match('/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.pnj\\.ac\\.id$/', $email) || 
     preg_match('/^[a-zA-Z0-9._%+-]+@pnj\\.ac\\.id$/', $email)) && 
    !preg_match('/@stu\\.pnj\\.ac\\.id$/', $email)
    ```
  - **Validation Pattern (JavaScript):**
    ```javascript
    // Mahasiswa
    const mahasiswaPattern = /^[a-zA-Z0-9._%+-]+\.[a-zA-Z0-9]@stu\.pnj\.ac\.id$/;
    
    // Dosen/Admin
    const dosenPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.pnj\.ac\.id$/;
    const pnjDirectPattern = /^[a-zA-Z0-9._%+-]+@pnj\.ac\.id$/;
    const stuPattern = /@stu\.pnj\.ac\.id$/;
    // Valid if: (dosenPattern OR pnjDirectPattern) AND NOT stuPattern
    ```
  - **Implementation locations:**
    - Server-side: `RegisterController::submit()`, `AdminController::create_admin()`, `AdminController::update_admin()`, `LoginController::sendResetOTP()`
    - Client-side: `assets/js/regis.js`, `assets/js/member-list.js` (validateAddForm, validateEditForm)
  - **Test file:** `temp/test_validasi_email_pnj.php` contains comprehensive test cases
- **Registration Flow:**
  - New users register with role `'User'` and status `'Tidak Aktif'`
  - Mahasiswa: fills jurusan, prodi, and uploads validasi_mahasiswa (screenshot KubacaPNJ)
  - Dosen/Tenaga Pendidikan: leaves jurusan, prodi, and validasi_mahasiswa empty/null
  - Admin validates and activates account via Member List
  - Foto profil uploaded separately after registration via profile page
- **Login Flow:**
  - **CRITICAL: Login uses EMAIL (not username) for authentication** - email is unique and validated
  - Validates email format and PNJ domain before authentication
  - Validates email + password against database using `AkunModel::loginByEmail()`
  - Checks captcha validation (case-insensitive comparison)
  - Rejects login if status is `'Tidak Aktif'`
  - Sets session with full user data
  - Redirects based on role: Admin/Super Admin â†’ admin dashboard, User â†’ user dashboard
  - Form field: `<input type="email" name="Email">` with placeholder `nama@pnj.ac.id`
- **Role-based access control (RBAC):**
  - **CRITICAL: Enforce role separation strictly!**
  - **User** (includes Mahasiswa/Dosen/Tenaga Pendidikan): Can ONLY access booking features, cannot access admin pages
  - **Admin:** Can access admin dashboard, kelola ruangan, laporan, booking list, member list. CANNOT access booking external or make bookings
  - **Super Admin:** Full access including booking external. CANNOT make bookings
  - **Important:** Admin and Super Admin should NEVER be able to create bookings for themselves
  - `AdminController.__construct()` checks role and redirects non-admins to dashboard
  - `DashboardController::index()` redirects admins to admin dashboard
  - Views conditionally render content based on `$_SESSION['user']['role']`
  - Example: `view/profile/index.php` shows admin dashboard grid for admins, user tabs for regular users
  - **Always validate role in BOTH controller AND view for security**
- **User notifications:**
  - Controllers use JavaScript `alert()` for user feedback messages
  - Pattern: `echo "<script>alert('message'); window.location.href='URL';</script>"; exit;`
  - Use `addslashes()` for dynamic messages containing variables or quotes
  - Common messages: registration success, login errors, validation errors

## Captcha Implementation
**Server:** `view/components/captcha.php` generates GD image, stores code in `$_SESSION['code']`  
**View template:**
```php
<img src="<?= $asset('view/components/captcha.php') ?>" id="captchaImage">
<input type="text" name="captcha" required>
```
**Client:** `assets/js/captcha.js` refreshes image on click/button with cache-busting `?r=timestamp`  
**Validation:** Controller compares `$_POST['captcha']` with `$_SESSION['code']` (case-insensitive)

## AJAX Implementation Guidelines
**Best Practice:** Use AJAX for dynamic features that benefit from asynchronous updates. For simple CRUD operations, traditional form submissions are often simpler.

**Existing AJAX endpoints (reference patterns):**
- `?page=booking&action=get_user_by_nim&nim={nim}` â€” Returns JSON user data for NIM lookup
  - Response: `{"success": bool, "data": {...}, "message": string}`
  - Used in: `assets/js/booking.js` for adding booking participants
- `?page=booking&action=get_booked_timeslots&id_ruangan={id}&tanggal={date}` â€” Returns JSON of booked time slots
  - Response: `[{"kode_booking": string, "waktu_mulai": string, "waktu_selesai": string}, ...]`
  - Used in: `assets/js/booking.js` for timeline conflict detection

**AJAX Best Practices:**
- Use `fetch()` API (modern JavaScript) instead of XMLHttpRequest
- Always set `header('Content-Type: application/json')` in PHP
- Return consistent JSON structure: `{"success": bool, "data": mixed, "message": string}`
- Handle errors with try-catch in JavaScript and proper HTTP status codes
- Show loading states during async operations

**When to use AJAX vs Traditional Forms:**
- **Use AJAX:** Real-time search, dynamic filtering, partial page updates, auto-save features
- **Use Forms:** Full page CRUD operations, file uploads, simple navigation
- **Consider UX:** AJAX improves experience when avoiding full page reloads adds value

## Page Guards & Access Control
**Admin protection:** `AdminController.__construct()` enforces role check:
```php
if (!isset($_SESSION['user']) || !in_array($_SESSION['user']['role'], ['Admin', 'Super Admin'])) {
    header('Location: index.php?page=dashboard');
    exit;
}
```

**Superadmin-only features:** Check role within specific action methods:
```php
if ($_SESSION['user']['role'] !== 'Super Admin') {
    header('Location: index.php?page=admin&action=kelola_ruangan');
    exit;
}
```

**Conditional rendering in views:** Use PHP conditionals for role-based UI:
```php
<?php if (isset($_SESSION['user']) && in_array($_SESSION['user']['role'], ['Admin', 'Super Admin'])): ?>
    <!-- Admin content -->
<?php else: ?>
    <!-- User content -->
<?php endif; ?>
```

## Routing & Controllers
**Controller pattern (see `BookingController.php` or `LoginController.php`):**
```php
class FeatureController {
    private FeatureModel $model;
    
    public function __construct() {
        $this->model = new FeatureModel();
    }
    
    public function index(): void {
        $this->renderIndexView();
    }
    
    private function renderIndexView(): void {
        require __DIR__ . '/../view/feature/index.php';
    }
}
```

**To add new feature:**
1. Create `controller/FeatureController.php` with methods like `index()`, `submit()`
2. Create `model/FeatureModel.php` (even if empty stub initially)
3. Add to `index.php` autoloader:
   ```php
   'FeatureController' => __DIR__ . '/controller/FeatureController.php',
   'FeatureModel' => __DIR__ . '/model/FeatureModel.php',
   ```
4. Add case to `switch ($halaman)`: `case 'feature': $controller = new FeatureController(); break;`
5. **Missing `break;` statement will cause default fallthrough to home page!**
6. Link to it: `/index.php?page=feature&action=index`

Controllers use typed properties (`private FeatureModel $model;`) and return types (`: void`) consistently.

## Tailwind Build
**Commands (from project root in PowerShell):**
- `npm run watch:css` â€” watch mode during development (auto-rebuild on `input.css` changes)
- `npm run build:css` â€” minified production build
**Version:** Tailwind CSS 4.1.16 via `@tailwindcss/cli`
**Source â†’ Output:** `assets/css/input.css` â†’ `assets/css/main.css`
**Note:** Always rebuild after editing `assets/css/input.css` before committing UI changes
**Setup:** Run `npm install` once after cloning to install dependencies

## Development Environment
- **Path:** `C:\xampp\htdocs\` (project may be in root or subfolder)
- **Shell:** PowerShell (pwsh.exe)
- **Server:** Start Apache + MySQL via XAMPP control panel
- **Access:** `http://localhost/` or `http://localhost/PBL%20Perpustakaan/` (subfolder auto-detected by `$asset()` helper)
- **Database:** MySQL on `127.0.0.1`, DB: `PBL-Perpustakaan`, User: `root`, Pass: `admin`
- **Git Workflow:** Feature branches follow numbered pattern (e.g., `29-implementasi-booking`)
- **Debugging & Testing:**
  - **CRITICAL:** ALL debug files, experiments, and POCs MUST be placed in `temp/` folder
  - The `temp/` folder contains implementation notes and bugfix documentation for reference
  - **temp/ folder structure:**
    - `IMPLEMENTASI_*.md` â€” Feature implementation guides and patterns (e.g., `IMPLEMENTASI_KELOLA_RUANGAN.md`)
    - `BUGFIX_*.md` â€” Bug fix documentation with solutions (e.g., `BUGFIX_MODAL_TIDAK_TERTUTUP.md`)
    - `FIX_*.md` â€” Configuration fixes and guides (e.g., `FIX_EMAIL_SENDER_CONFIG.md`)
    - `test_*.php` â€” Test/debug scripts for features (e.g., `test_email.php`, `test_validasi_email_pnj.php`)
    - `debug_*.php` â€” Debug utilities (e.g., `debug_session.php`, `debug_tombol_selesai.php`)
    - `*.sql` â€” Database migration scripts (e.g., `MIGRATION_PENGATURAN_SISTEM.sql`)
  - This keeps the main codebase clean and prevents accidental commits of debug code
  - Never create debug files in controller/, model/, or view/ directories

## Test Scripts (`temp/test_*.php`)
**Purpose:** Isolated testing of specific features without running full application

**Common test scripts:**
- `test_email.php` â€” Test SMTP connection and email sending (includes Gmail App Password troubleshooting)
- `test_email_cli.php` â€” CLI version for terminal testing
- `test_validasi_email_pnj.php` â€” Validate PNJ domain email patterns (mahasiswa vs dosen/admin)
- `test_login_email.php` â€” Test authentication with email-based login
- `test_foto_path_debug.php` â€” Debug foto_profil path issues and file existence
- `test_checkin_status.php` â€” Verify check-in logic and anggota_booking relationships
- `test_laporan_most_booked.php` â€” Test booking statistics and reporting queries
- `test_validasi_waktu_masa_lalu.php` â€” Validate date/time business rules

**Usage pattern:**
```php
// Typical test script structure
require_once __DIR__ . '/../config/Koneksi.php';
$pdo = Koneksi::getConnection();

// Test specific functionality
// Output results with var_dump() or echo
// Include visual feedback (HTML tables, success/error messages)
```

**When to create test scripts:**
- Complex validation logic needs verification
- External service integration (SMTP, file uploads)
- Database query optimization
- Email domain validation patterns
- Path resolution issues

## Database Migrations
**Location:** `temp/MIGRATION_*.sql` files document schema changes

**Migration pattern:**
```sql
-- Migration: Feature Name
-- Created: YYYY-MM-DD
-- Purpose: Why this change is needed

USE `pbl-perpustakaan`;

-- Create tables with IF NOT EXISTS
CREATE TABLE IF NOT EXISTS `new_table` (
  `id` int NOT NULL AUTO_INCREMENT,
  -- columns with COMMENT for documentation
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Insert default/seed data
INSERT INTO `new_table` (...) VALUES (...);
```

**Key principles:**
- Use `IF NOT EXISTS` to make migrations idempotent
- Document EVERY column with COMMENT
- Include purpose and creation date in header
- Add sample/seed data for new tables
- Foreign keys with CASCADE/RESTRICT behavior
- Reference `created_by`/`updated_by` to `akun.nomor_induk`

**Examples:**
- `MIGRATION_PENGATURAN_SISTEM.sql` â€” Added `waktu_operasi` and `hari_libur` tables
- `MIGRATION_INVITATION_CONFIRM.sql` â€” Added invitation confirmation workflow

**Execution:**
```powershell
# Via MySQL CLI
mysql -u root -p PBL-Perpustakaan < temp/MIGRATION_FEATURE_NAME.sql

# Or via phpMyAdmin
# Import â†’ Choose file â†’ Go
```

## Email Configuration
**CRITICAL:** Email sending requires proper SMTP configuration in XAMPP. See `temp/SETUP_EMAIL_COMPLETE.md` for comprehensive guide.

**Quick troubleshooting:**
- Error "Username and Password not accepted" â†’ App Password expired, generate new one
- Wrong sender email â†’ Check `force_sender` in `C:\xampp\sendmail\sendmail.ini`
- Email not sending â†’ Verify Apache restart after config changes

**Configuration hierarchy (highest to lowest priority):**
1. `sendmail.ini` â†’ `force_sender` (overrides ALL From: headers)
2. PHP code â†’ `From:` header (from constants)
3. `php.ini` â†’ `sendmail_from` (fallback)
4. `sendmail.ini` â†’ `auth_username` (SMTP auth)

**Current sender:** `bookez.web@gmail.com` (configured in `config/Email.php`)

## Code Structure & Best Practices

### Controller-Model Pattern
**Controllers** (in `controller/`) handle HTTP requests, validation, and orchestration:
- Use typed properties: `private BookingModel $model;`
- Use return types: `public function index(): void`
- Initialize session safely: `if (session_status() === PHP_SESSION_NONE) { session_start(); }`
- Render views via `require __DIR__ . '/../view/feature/index.php'`
- Handle both GET (display form) and POST (process form) in same action method with `if ($_SERVER['REQUEST_METHOD'] === 'POST')`
- User notifications: `echo "<script>alert('message'); window.location.href='URL';</script>"; exit;`
- Use `addslashes()` for dynamic messages with variables/quotes
- Always `exit;` after header redirects to prevent continued execution

**Models** (in `model/`) handle data access via PDO:
- Constructor initializes PDO: `$koneksi = new Koneksi(); $this->pdo = $koneksi->getPdo();`
- Use prepared statements for ALL queries with user input (security critical!)
- Transactions for multi-table operations: `$this->pdo->beginTransaction()` + `commit()`/`rollBack()`
- Standard CRUD methods: `create()`, `getById()`, `getAll()`, `update()`, `delete()`
- Validation methods: `isEmailExists()`, `checkSuspendStatus()`, `hasActiveBooking()`, etc.
- Filter methods return arrays: `filter(array $filters = []): array`
- Complex operations use transactions with proper rollback on exceptions

**Example pattern:**
```php
// Controller action handling both GET and POST
public function submit(): void {
    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        header('Location: index.php?page=feature');
        exit;
    }
    // Validate input...
    $result = $this->model->create($data);
    if ($result) {
        echo "<script>alert('Success!'); window.location.href='...';</script>";
    } else {
        echo "<script>alert('Failed!'); window.location.href='...';</script>";
    }
    exit;
}

// Model with transaction
public function create(array $data): int|false {
    $this->pdo->beginTransaction();
    try {
        // Multiple related inserts...
        $this->pdo->commit();
        return $id;
    } catch (Exception $e) {
        $this->pdo->rollBack();
        return false;
    }
}
```

### JavaScript Separation of Concerns
**CRITICAL: NO inline `<script>` blocks or internal scripts in view files!** All JavaScript MUST be in external files under `assets/js/`.

**AJAX Usage Guidelines:**
- **Use `fetch()` API** for asynchronous requests (modern standard)
- **Pattern:** `fetch(url).then(r => r.json()).then(data => handleSuccess(data)).catch(err => handleError(err))`
- **Always handle errors** with try-catch blocks and show user-friendly error messages
- **Loading states:** Show spinners or disable buttons during async operations
- **Traditional forms still valid:** Use for simple CRUD where full page reload is acceptable
- **Examples of good AJAX use cases:**
  - Live search and autocomplete
  - Real-time validation (e.g., check if email exists)
  - Dynamic filtering without page reload
  - Partial page updates (e.g., updating a table row)
  - Real-time conflict checking (e.g., booking time slots)
- **Current AJAX endpoints:** `BookingController::get_user_by_nim()`, `BookingController::get_booked_timeslots()`, `AdminController::load_members()`

**Pattern for page-specific JS (UPDATED - NO inline scripts):**
1. Create `assets/js/{page-name}.js` for page-specific behavior (e.g., `dashboard.js`, `booking.js`)
2. Use `assets/js/main.js` ONLY for truly global functionality needed across all pages
3. **Pass data via hidden div with data attributes (NOT inline script blocks):**
   ```php
   <!-- In view file before closing </body> -->
   <div id="feature-data" 
        data-base-path="<?= $basePath ?>" 
        data-user-role="<?= $_SESSION['user']['role'] ?? '' ?>"
        data-rooms='<?= json_encode($rooms ?? []) ?>' 
        style="display:none;">
   </div>
   <script src="<?= $asset('assets/js/page-name.js'); ?>" defer></script>
   ```
4. **Initialize data in external JS file:**
   ```javascript
   // In assets/js/page-name.js
   document.addEventListener('DOMContentLoaded', function() {
       const dataContainer = document.getElementById('feature-data');
       if (dataContainer) {
           window.ASSET_BASE_PATH = dataContainer.dataset.basePath || '';
           window.USER_ROLE = dataContainer.dataset.userRole || '';
           window.ROOMS_DATA = JSON.parse(dataContainer.dataset.rooms || '[]');
       }
       initFeature();
   });
   ```

**Event delegation pattern (NO onclick attributes):**
```javascript
// WRONG: <button onclick="openModal()">
// RIGHT: Use event delegation in external JS
document.addEventListener('click', function(event) {
    const btn = event.target.closest('[data-action="open-modal"]');
    if (btn) {
        const modalId = btn.dataset.modalId;
        openModal(modalId);
    }
});
```

**Accessing asset paths in JS:**
```javascript
// In external JS files, use exposed global variable
const logoUrl = window.ASSET_BASE_PATH + '/assets/image/logo.png';
```

**Modern AJAX patterns (recommended):**
- Use `fetch()` API with async/await for cleaner code
- Existing patterns: `BookingController::get_user_by_nim()`, `AdminController::load_members()`
- Implement proper error handling and loading states
- Consider user experience when choosing between AJAX and traditional forms

**Data Attributes Pattern (Standard across all pages):**
```php
<!-- View: Pass data via hidden container -->
<div id="page-data" 
     data-base-path="<?= $basePath ?>"
     data-user-role="<?= $_SESSION['user']['role'] ?? '' ?>"
     data-json='<?= json_encode($data ?? []) ?>'
     style="display:none;">
</div>

<!-- View: Use data attributes instead of onclick -->
<button data-action="edit" data-room-id="<?= $room['id'] ?>" class="btn-edit">Edit</button>
<button data-action="delete" data-room-id="<?= $room['id'] ?>" class="btn-delete">Delete</button>
```

```javascript
// JS: Initialize from data attributes (NOT inline window.* assignments)
document.addEventListener('DOMContentLoaded', function() {
    const dataContainer = document.getElementById('page-data');
    if (dataContainer) {
        window.ASSET_BASE_PATH = dataContainer.dataset.basePath || '';
        window.USER_ROLE = dataContainer.dataset.userRole || '';
        window.DATA = JSON.parse(dataContainer.dataset.json || '[]');
    }
    initPage();
});

// JS: Event delegation (NOT onclick attributes)
document.addEventListener('click', function(event) {
    const editBtn = event.target.closest('[data-action="edit"]');
    if (editBtn) {
        const roomId = editBtn.dataset.roomId;
        openEditModal(roomId);
    }
    
    const deleteBtn = event.target.closest('[data-action="delete"]');
    if (deleteBtn) {
        const roomId = deleteBtn.dataset.roomId;
        openDeleteModal(roomId);
    }
});
```

**Existing JS modules:**
- `auth.js` â€” logout handling (listens for `#btn-logout`)
- `captcha.js` â€” CAPTCHA refresh with cache-busting
- `booking.js` â€” booking form interactions, anggota management, timeline conflict detection
- `booking-list.js` â€” admin booking list with modal check-in functionality (uses data attributes)
- `profile.js` â€” profile page tab switching + foto profil upload modal with preview
- `dashboard.js` â€” user dashboard (booking flow + room modals, uses data attributes)
- `admin.js` â€” admin dashboard card zoom effects + booking external tab switching (uses data attributes)
- `member-list.js` â€” admin member management (tab switching, modals, uses data attributes for USER_ROLE)
- `feedback.js` â€” feedback form rating selection and validation
- `startpage.js` â€” landing page interactions
- `regis.js` â€” registration form handling (enforces 8-character minimum password)
- `reset-password.js` â€” password reset functionality
- `pengaturan.js` â€” system settings tab switching + modal handling (Super Admin only)
- `kelola-ruangan.js` â€” room management modals (uses data attributes + event delegation)
- `laporan.js` â€” admin reports filtering (uses data attributes for tab switching)
- `skrip_sebelum_dashboard.js` â€” pre-dashboard scripts
- `main.js` â€” (reserved for global functionality)

### CSS Separation of Concerns
**CRITICAL: NO inline styles or internal `<style>` blocks!** All CSS MUST be in external files under `assets/css/`.

**Pattern:**
1. Global styles: `assets/css/main.css` (Tailwind compiled, auto-included by `head.php`)
2. Page-specific styles: Create `assets/css/{page-name}.css` for custom styling beyond Tailwind
3. Link in view's `<head>` after including `head.php`:
   ```php
   <link rel="stylesheet" href="<?= $asset('assets/css/page-name.css') ?>">
   ```

**Existing CSS files:**
- `main.css` â€” Tailwind compiled output (auto-included globally)
- `profile.css`, `dashboard.css`, `admin-dashboard.css`, `booking.css`
- `booking-external.css`, `member-list.css`, `kelola-ruangan.css`, `laporan.css`, `pengaturan.css`

**Reusable view components:**
- `view/components/head.php` â€” Standard `<head>` with `$asset()` helper (REQUIRED in all views)
- `view/components/navbar_admin.php` â€” Admin navigation bar (conditionally shows Super Admin features)
- `view/components/Footer.php` â€” Site footer
- `view/components/captcha.php` â€” CAPTCHA image generator (also serves as dynamic endpoint)
- `view/components/pagination.php` â€” Pagination component (note: currently inline pagination pattern is preferred over include)
- `view/components/modal_change_password.php` â€” Password change modal
- `view/components/modal_reset_password.php` â€” Password reset modal

## Admin Area Structure
**Navbar:** `view/components/navbar_admin.php` provides admin navigation:
- Links: Kelola Ruangan, Laporan Peminjaman, Booking-List, Member-List
- Conditionally shows "Booking Eksternal" link ONLY for Super Admin role
- Uses inline SVG icons (no external icon libraries like Font Awesome or Lucide)

**Dashboard:** `view/admin/dashboard.php` displays grid of admin features:
- Responsive grid layout (7 columns on desktop, adapts on mobile/tablet)
- Card sizes dynamically adjust based on user role (Super Admin sees all features including Booking Eksternal)
- Cards use `.card-zoom-image` class for hover zoom effects (defined in `admin-dashboard.css`)
- Each card is a clickable link to corresponding admin action

**Booking External:** `view/admin/booking_external.php` (Super Admin ONLY):
- Two-column layout: left for booking form (toggleable card/form states), right for schedule table
- Tab system: "Mendatang" and "Histori" for viewing bookings
- Filter inputs for Ruangan, Instansi, Tanggal
- Form includes: Pilih Ruangan (select), Nama Instansi, Surat Lampiran (file upload), Tanggal, Jam (dual time inputs)
- JavaScript: `assets/js/admin.js` handles form toggle and tab switching

**Member Management:** `view/admin/member_list.php` + `assets/js/member-list.js`:
- **CRITICAL PATTERNS:**
  - **Pagination Persistence:** Tab switching preserves pagination via URL parameters (`pg_user`, `pg_admin`)
    - State tracked in JS: `currentPageUser`, `currentPageAdmin` 
    - `switchTab()` updates URL with `window.location.href` (full page reload, not AJAX)
    - `initializeActiveTab()` reads URL params to restore pagination state
  - **Dynamic Table Headers:** `updateTableHeader(tab)` adjusts col-span based on active tab
    - User: 6 columns (Profil(1) | Nama(3) | Nomor Induk(2) | Prodi(2) | Validasi(2) | Status(2))
    - Admin: 4 columns (Profil(3) | Nama(4) | NIP(3) | Status(2))
    - Header elements have IDs (`header-profil`, `header-nama`, etc.) for dynamic updates
  - **Server-side Rendering First:** Initial load shows PHP-rendered data, JavaScript only for tab switching
- Tab switching between User/Admin lists with proper URL state management
- FAB (Floating Action Button) for adding admins (hidden on User tab, visible on Admin tab)
- Modal system with 4 modes: `'view'`, `'edit'`, `'add'`, `'delete_confirm'`
- All icons are inline SVG (no external libraries)
- Password validation: minimum 8 characters, email domain validation for PNJ
- AJAX endpoint: `admin&action=load_members&tab={user|admin}&page_num={n}` returns JSON with pagination

## Database Schema Quick Reference
**Key tables and relationships:**
- `akun` (PK: `nomor_induk`) â€” user accounts with role enum
- `ruangan` (PK: `id_ruangan`) â€” rooms with jenis_ruangan ('Ruang Rapat', 'Ruang Umum')
- `booking` (PK: `id_booking`) â€” bookings linked to ruangan and status_booking
- `anggota_booking` â€” many-to-many join table (booking â†” akun) with check-in tracking (proper relationship via nomor_induk)
- `schedule` â€” reschedule requests linked to booking
- `feedback` â€” post-booking feedback
- `pelanggaran_suspensi` â€” violation/suspension records linked to akun
- `status_booking` â€” booking status lookup (AKTIF, SELESAI, DIBATALKAN, HANGUS)

**Important constraints:**
- Rooms have `minimal_kapasitas_ruangan` (min participants) and `maksimal_kapasitas_ruangan` (max participants)
- Booking validation enforces participant count MUST be between min-max capacity range
- `anggota_booking` tracks `is_ketua` (1 = leader), `is_checked_in`, and `waktu_check_in`
- Foreign keys enforce referential integrity with CASCADE/RESTRICT rules

## File Upload Handling
**Upload directories:** Files stored in `assets/uploads/` with category separation:
- `assets/uploads/images/` â€” photos/images (room photos, avatars, validasi_mahasiswa screenshots)
- `assets/uploads/docs/` â€” PDF documents (surat_lampiran for external bookings)

**Security requirements (see `AdminController::submit_booking_external()` for reference):**
- Validate MIME type via `finfo_file()`: images (`image/jpeg`, `image/png`, `image/webp`), docs (`application/pdf`)
- Enforce size limits: max 25MB for both images and PDFs
- Generate unique filenames: `'surat_' . time() . '_' . bin2hex(random_bytes(8)) . '.' . $extension`
- Use `move_uploaded_file()` only
- Create directory if not exists: `if (!is_dir(dirname($uploadPath))) { mkdir(dirname($uploadPath), 0755, true); }`

**Implementation pattern:**
```php
// 1. Validate file
$allowedTypes = ['application/pdf'];
$finfo = finfo_open(FILEINFO_MIME_TYPE);
$mimeType = finfo_file($finfo, $file['tmp_name']);
finfo_close($finfo);

if (!in_array($mimeType, $allowedTypes)) {
    echo "<script>alert('Hanya file PDF yang diperbolehkan!');</script>";
    exit;
}

// 2. Generate unique filename
$extension = pathinfo($file['name'], PATHINFO_EXTENSION);
$filename = 'surat_' . time() . '_' . bin2hex(random_bytes(8)) . '.' . $extension;
$uploadPath = __DIR__ . '/../assets/uploads/docs/' . $filename;

// 3. Move file
if (move_uploaded_file($file['tmp_name'], $uploadPath)) {
    $suratLampiran = 'assets/uploads/docs/' . $filename; // Store relative path in DB
}
```

**Form requirements for file uploads:**
```php
<form method="POST" enctype="multipart/form-data" action="?page=...&action=...">
    <input type="file" name="lampiran" accept=".pdf">
</form>
```

## Feedback System
**Flow:** After booking completion (status SELESAI), users rate their experience on a scale of 1-5 using emoji buttons.

**View:** `view/feedback.php` displays post-booking message with rating options:
- Rating 5 (Senyum/Green) â€” excellent experience
- Rating 3 (Netral/Yellow) â€” neutral experience  
- Rating 1 (Sedih/Red) â€” poor experience
- JavaScript: `assets/js/feedback.js` handles rating selection and form submission

**Model:** `FeedbackModel` stores ratings with additional fields:
- `id_booking` â€” links feedback to specific booking
- `skala_kepuasan` (1 or 5) â€” user satisfaction score (1=tidak puas/emoji sedih, 5=sangat puas/emoji senyum)
- `kritik_saran` (required) â€” text feedback, gabungan kritik dan saran dalam satu field

**Integration:** Feedback data used in admin reports (`view/admin/laporan.php`) to track room/service quality trends.

## Email Notifications
**Configuration:** `config/Email.php` handles email sending via SMTP
- Sender email: `bookez.web@gmail.com`
- Used for system notifications (suspension alerts, booking confirmations, etc.)

**Current notification triggers:**
- **7-day suspension:** When user accumulates 3 HANGUS bookings in 30 days (triggered by `BookingListModel::autoUpdateHangusStatus()`)
- Email sent to user's registered email address from `$_SESSION['user']['email']` or database

**Pattern for sending notifications:**
```php
// In model or controller after suspension is applied
require_once __DIR__ . '/../config/Email.php';
// Email::send($to, $subject, $message);
// Implementation details in Email.php
```

**Note:** Email integration planned for future features (booking confirmations, reminders, reschedule notifications). Currently, user notifications use JavaScript `alert()` for immediate feedback.

## Booking Lifecycle & Business Rules
**Critical constraints enforced in models and controllers:**

**1. One Active Booking Per User:**
- User can only have ONE booking with status AKTIF at a time
- Check via `BookingModel::hasActiveBooking($nomor_induk)` before allowing new booking
- Prevents resource hogging and ensures fair access

**2. Room Capacity Validation:**
- Participant count MUST be between room's `minimal_kapasitas_ruangan` and `maksimal_kapasitas_ruangan`
- Enforced during booking creation in `BookingController::buat_booking()`
- Ketua (leader) + anggota (members) = total participants

**3. Violation System & Suspensions:**
- **HANGUS status:** Auto-assigned if no check-in within 10 minutes past `waktu_mulai`
- **24-hour block:** First HANGUS in 30-day window â†’ cannot book for 24 hours
- **7-day suspension:** 3rd HANGUS in 30-day window â†’ 7-day suspension + email notification
- Stored in `pelanggaran_suspensi` table with `tanggal_mulai` and `tanggal_selesai`
- Check via `BookingModel::checkBookingBlock($nomor_induk)` before allowing new booking

**4. Booking Status Transitions:**
```
AKTIF (1) â†’ [time passes waktu_selesai] â†’ SELESAI (2) [auto]
          â†’ [check-in completed + time passes] â†’ SELESAI (2) [auto]
          â†’ [user cancels] â†’ DIBATALKAN (3)
          â†’ [no check-in + 10min late] â†’ HANGUS (4) [auto]
```

**5. Cross-Feature Integration Points:**
- **Suspension blocks new bookings:** `BookingController::buat_booking()` calls `BookingModel::checkBookingBlock()` before allowing creation
- **HANGUS triggers suspensions:** `BookingListModel::autoUpdateHangusStatus()` checks violation count and creates suspension records
- **Email notifications:** `config/Email.php` sends alerts when 7-day suspension applied
- **Feedback collection:** Only SELESAI bookings trigger feedback prompt (`view/feedback.php`)
- **Operational hours validation:** `BookingController::buat_booking()` calls `PengaturanModel::validateWaktuOperasi()` before creation
- **Holiday blocking:** `PengaturanModel::validateHariLibur()` prevents bookings on registered holiday dates
- **Room status sync:** `RuanganModel::autoUpdateRoomStatus()` reflects 'Sedang Digunakan' when booking is AKTIF during its time window

## Automated Status Updates
**Critical system behaviors:** Several models implement auto-update methods called at controller entry points

**1. Auto-Update SELESAI Status** (`BookingListModel::autoUpdateSelesaiStatus()`):
- Called in `AdminController::booking_list()` and `BookingController::index()`
- Logic: If booking is AKTIF AND current time > waktu_selesai â†’ set SELESAI
- Applies to ALL bookings (both user and external bookings)
- Must be called BEFORE `autoUpdateHangusStatus()` to prevent status conflicts

**2. Auto-Update HANGUS Status** (`BookingListModel::autoUpdateHangusStatus()`):
- Called in `AdminController::booking_list()` and `BookingController::index()`
- Logic: If booking is AKTIF AND no check-in AND >10 minutes past waktu_mulai â†’ set HANGUS
- Also triggers suspension check: 3 HANGUS in 30 days â†’ 7-day suspension + email notification

**3. Auto-Update Room Status** (`RuanganModel::autoUpdateRoomStatus()`):
- Called in same entry points as above
- Updates `status_ruangan` to 'Sedang Digunakan' or 'Tersedia' based on current time vs active schedules
- Pattern: Check if NOW() is between any AKTIF booking's waktu_mulai and waktu_selesai

**Pattern to follow when adding features:**
```php
public function some_booking_related_action(): void {
    // ALWAYS call these at the start
    $bookingListModel = new BookingListModel();
    $ruanganModel = new RuanganModel();
    
    $bookingListModel->autoUpdateSelesaiStatus();
    $bookingListModel->autoUpdateHangusStatus();
    $ruanganModel->autoUpdateRoomStatus();
    
    // Then proceed with actual logic...
}
```

## Pagination Pattern
**Reusable component:** `view/components/pagination.php` provides consistent pagination UI across all list views.

**Implementation pattern (see `AdminController::booking_external()` or `ProfileController::renderIndexView()`):**
```php
// 1. Setup pagination parameters
$perPage = 10;  // Records per page
$currentPage = isset($_GET['pg']) ? max(1, (int)$_GET['pg']) : 1;
$offset = ($currentPage - 1) * $perPage;

// 2. Add to model filter
$filters = [
    'nama_ruangan' => $_GET['ruang'] ?? '',
    'limit' => $perPage,
    'offset' => $offset
];

// 3. Fetch paginated data
$records = $model->filter($filters);
$totalRecords = $model->countFiltered($countFilters);
$totalPages = ceil($totalRecords / $perPage);

// 4. Pass to view
$paginationData = [
    'currentPage' => $currentPage,
    'totalPages' => $totalPages,
    'totalRecords' => $totalRecords,
    'perPage' => $perPage
];
```

**View implementation:** Inline pagination UI (not using component include pattern):
```php
<?php if (isset($paginationData) && $paginationData['totalPages'] > 1): ?>
    <!-- Pagination controls with filter preservation -->
    <a href="?page=admin&action=booking_external&pg=<?= $currentPage - 1 ?>&ruang=<?= $_GET['ruang'] ?? '' ?>">Prev</a>
<?php endif; ?>
```

**Key principles:**
- Use `pg` parameter for page number (not `page` to avoid conflict with routing)
- Always preserve filters in pagination URLs
- Model must implement both `filter()` and `countFiltered()` methods
- Pagination auto-hides when `totalPages <= 1`
- Standard: 10 records per page for admin lists, 6 for user history

**Multi-tab pagination (see `member_list.php`):**
- Use separate parameters: `pg_user`, `pg_admin` for independent pagination state
- Persist in URL when switching tabs: `window.location.href = url.toString();`
- JavaScript tracks: `currentPageUser`, `currentPageAdmin` variables
- `switchTab()` preserves pagination by reading from state variables and updating URL

## Critical Anti-Patterns to Avoid
**Missing `break;` in switch statement:** Will cause default fallthrough to home page!
```php
switch ($halaman) {
    case 'feature':
        $controller = new FeatureController();
        break;  // CRITICAL: Don't forget this!
    default:
        // Falls through to home if break missing
}
```

**Poor AJAX implementation:** When using AJAX, always handle errors, show loading states, and return consistent JSON structure. Don't use AJAX for simple operations where traditional forms would be simpler and more maintainable.

**Pagination without URL state:** When implementing pagination with tab switching:
- âŒ WRONG: Use only JavaScript state (resets on page reload/navigation)
- âœ… CORRECT: Persist state in URL parameters (`pg_user`, `pg_admin`)
- Pattern: `switchTab()` â†’ update URL with `window.location.href` â†’ server renders correct page
- See `member-list.js` and `temp/BUGFIX_PAGINATION_PERSISTENCE.md` for reference

**Role logic violations:** Admin/Super Admin should NEVER be able to create bookings. Users should NEVER access admin features. Always validate role in both controller and view.

**Inline JavaScript or CSS:** NEVER write inline `<script>` or `<style>` blocks in views. Always use external files in `assets/js/` or `assets/css/`.

**Misaligned table headers/records:** When implementing dynamic tables with different column structures per tab:
- âŒ WRONG: Static header with varying record col-spans (causes misalignment)
- âœ… CORRECT: Dynamic header with matching col-spans via JavaScript
- Pattern: Add IDs to header elements, create `updateTableHeader(tab)` function to adjust col-span
- Example: User tab shows 6 columns, Admin tab shows 4 columns (same 12-column grid)
- See `member_list.php` header with IDs + `member-list.js` `updateTableHeader()` function

**Direct PDO in views:** Views should never contain database queries. Always use models for data access.

**Forgetting auto-update calls:** Booking-related controllers MUST call `autoUpdateHangusStatus()` and `autoUpdateRoomStatus()` at entry points to maintain system integrity.

## Pagination Pattern
**Reusable component:** `view/components/pagination.php` provides consistent pagination UI across all list views.

**Implementation pattern (see `AdminController::booking_external()` or `ProfileController::renderIndexView()`):**
```php
// 1. Setup pagination parameters
$perPage = 10;  // Records per page
$currentPage = isset($_GET['pg']) ? max(1, (int)$_GET['pg']) : 1;
$offset = ($currentPage - 1) * $perPage;

// 2. Add to model filter
$filters = [
    'nama_ruangan' => $_GET['ruang'] ?? '',
    'limit' => $perPage,
    'offset' => $offset
];

// 3. Fetch paginated data
$records = $model->filter($filters);
$totalRecords = $model->countFiltered($countFilters);
$totalPages = ceil($totalRecords / $perPage);

// 4. Pass to view
$paginationData = [
    'currentPage' => $currentPage,
    'totalPages' => $totalPages,
    'totalRecords' => $totalRecords,
    'perPage' => $perPage
];
```

**View implementation:** Inline pagination UI (not using component include pattern):
```php
<?php if (isset($paginationData) && $paginationData['totalPages'] > 1): ?>
    <!-- Pagination controls with filter preservation -->
    <a href="?page=admin&action=booking_external&pg=<?= $currentPage - 1 ?>&ruang=<?= $_GET['ruang'] ?? '' ?>">Prev</a>
<?php endif; ?>
```

**Key principles:**
- Use `pg` parameter for page number (not `page` to avoid conflict with routing)
- Always preserve filters in pagination URLs
- Model must implement both `filter()` and `countFiltered()` methods
- Pagination auto-hides when `totalPages <= 1`
- Standard: 10 records per page for admin lists, 6 for user history

## Operational Hours & Holidays System
**Feature:** Super Admin can configure system-wide operational constraints that affect booking validation.

**Database tables:**
- `waktu_operasi` â€” 7 records (Senin-Minggu) with `jam_buka`, `jam_tutup`, `is_aktif` (can disable booking for specific days)
- `hari_libur` â€” Dynamic list of special dates (national holidays, campus events, maintenance) where booking is blocked

**Model:** `PengaturanModel` provides validation methods:
- `validateWaktuOperasi($hari, $waktuMulai, $waktuSelesai)` â€” Returns `['allowed' => bool, 'message' => string]`
- `validateHariLibur($tanggal)` â€” Checks if date is registered as holiday
- **CRITICAL:** Call these validators in `BookingController::buat_booking()` BEFORE creating booking to enforce constraints

**Controller actions (Super Admin only):**
- `admin&action=pengaturan` â€” Main settings page with 2 tabs (Waktu Operasi & Hari Libur)
- `admin&action=update_waktu_operasi` â€” Edit operational hours for specific day
- `admin&action=create_hari_libur` â€” Add new holiday
- `admin&action=update_hari_libur` â€” Edit existing holiday
- `admin&action=delete_hari_libur` â€” Remove holiday

**Integration points:**
- Validation enforced in booking creation (both user and external bookings)
- Dashboard shows "Perpustakaan tutup" message on inactive days
- Booking form JS can fetch operational hours to disable unavailable time slots

## Timeline & Conflict Detection
**Feature:** Real-time visual feedback for booking time conflicts via AJAX endpoint.

**Flow:**
1. User selects date â†’ JS calls `?page=booking&action=get_booked_timeslots` with `id_ruangan` and `tanggal`
2. Returns JSON with existing bookings: `[{kode_booking, waktu_mulai, waktu_selesai}, ...]`
3. JS displays timeline of occupied slots
4. JS validates selected time against timeline, shows warning if overlap detected
5. User can still submit (server-side validation is final arbiter)

**Implementation (in `assets/js/booking.js`):**
- `loadBookedTimeslots()` â€” Fetch and display timeline when date selected
- `validateTimeConflict()` â€” Real-time validation on time input change
- `checkTimeOverlap(start1, end1, start2, end2)` â€” Overlap detection algorithm

**Why not block submission:** Client-side validation is UX helper only. Server-side `ScheduleModel::isTimeSlotAvailable()` is authoritative to prevent race conditions.

## Code Generation Templates

### Template 1: Adding New CRUD Feature
```php
// Step 1: Create Model (model/FeatureModel.php)
class FeatureModel {
    private PDO $pdo;
    
    public function __construct() {
        $koneksi = new Koneksi();
        $this->pdo = $koneksi->getPdo();
    }
    
    public function getAll(): array {
        $stmt = $this->pdo->query("SELECT * FROM table_name ORDER BY created_at DESC");
        return $stmt->fetchAll();
    }
    
    public function getById(int $id): array|false {
        $stmt = $this->pdo->prepare("SELECT * FROM table_name WHERE id = ?");
        $stmt->execute([$id]);
        return $stmt->fetch();
    }
    
    public function create(array $data): int|false {
        try {
            $stmt = $this->pdo->prepare("
                INSERT INTO table_name (column1, column2, created_at) 
                VALUES (?, ?, NOW())
            ");
            $stmt->execute([$data['column1'], $data['column2']]);
            return (int)$this->pdo->lastInsertId();
        } catch (Exception $e) {
            error_log("Error creating record: " . $e->getMessage());
            return false;
        }
    }
    
    public function update(int $id, array $data): bool {
        try {
            $stmt = $this->pdo->prepare("
                UPDATE table_name 
                SET column1 = ?, column2 = ?, updated_at = NOW()
                WHERE id = ?
            ");
            return $stmt->execute([$data['column1'], $data['column2'], $id]);
        } catch (Exception $e) {
            error_log("Error updating record: " . $e->getMessage());
            return false;
        }
    }
    
    public function delete(int $id): bool {
        try {
            $stmt = $this->pdo->prepare("DELETE FROM table_name WHERE id = ?");
            return $stmt->execute([$id]);
        } catch (Exception $e) {
            error_log("Error deleting record: " . $e->getMessage());
            return false;
        }
    }
}

// Step 2: Create Controller (controller/FeatureController.php)
class FeatureController {
    private FeatureModel $model;
    
    public function __construct() {
        if (session_status() === PHP_SESSION_NONE) {
            session_start();
        }
        $this->model = new FeatureModel();
    }
    
    public function index(): void {
        $records = $this->model->getAll();
        require __DIR__ . '/../view/feature/index.php';
    }
    
    public function create(): void {
        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            header('Location: index.php?page=feature');
            exit;
        }
        
        // Validate input
        $column1 = trim($_POST['column1'] ?? '');
        $column2 = trim($_POST['column2'] ?? '');
        
        if (empty($column1) || empty($column2)) {
            echo "<script>alert('All fields required!'); window.location.href='index.php?page=feature';</script>";
            exit;
        }
        
        // Create record
        $data = ['column1' => $column1, 'column2' => $column2];
        $result = $this->model->create($data);
        
        if ($result) {
            echo "<script>alert('Created successfully!'); window.location.href='index.php?page=feature';</script>";
        } else {
            echo "<script>alert('Failed to create'); window.location.href='index.php?page=feature';</script>";
        }
        exit;
    }
    
    public function update(): void {
        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            header('Location: index.php?page=feature');
            exit;
        }
        
        $id = (int)($_POST['id'] ?? 0);
        $column1 = trim($_POST['column1'] ?? '');
        $column2 = trim($_POST['column2'] ?? '');
        
        if ($id <= 0 || empty($column1) || empty($column2)) {
            echo "<script>alert('Invalid input!'); window.location.href='index.php?page=feature';</script>";
            exit;
        }
        
        $data = ['column1' => $column1, 'column2' => $column2];
        $result = $this->model->update($id, $data);
        
        if ($result) {
            echo "<script>alert('Updated successfully!'); window.location.href='index.php?page=feature';</script>";
        } else {
            echo "<script>alert('Failed to update'); window.location.href='index.php?page=feature';</script>";
        }
        exit;
    }
    
    public function delete(): void {
        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            header('Location: index.php?page=feature');
            exit;
        }
        
        $id = (int)($_POST['id'] ?? 0);
        
        if ($id <= 0) {
            echo "<script>alert('Invalid ID!'); window.location.href='index.php?page=feature';</script>";
            exit;
        }
        
        $result = $this->model->delete($id);
        
        if ($result) {
            echo "<script>alert('Deleted successfully!'); window.location.href='index.php?page=feature';</script>";
        } else {
            echo "<script>alert('Failed to delete'); window.location.href='index.php?page=feature';</script>";
        }
        exit;
    }
}

// Step 3: Register in index.php autoloader
$mapmodeldancontroller = [
    // ... existing entries ...
    'FeatureController' => __DIR__ . '/controller/FeatureController.php',
    'FeatureModel' => __DIR__ . '/model/FeatureModel.php',
];

// Step 4: Add routing case
switch ($halaman) {
    // ... existing cases ...
    case 'feature':
        $controller = new FeatureController();
        break;  // CRITICAL: Don't forget break!
}
```

### Template 2: Adding Modal to Admin Page
```php
<!-- In view file (e.g., view/admin/feature.php) -->
<!-- Modal Trigger Button -->
<button onclick="openModal('add')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
    Add New
</button>

<!-- Modal Overlay -->
<div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeModal()"></div>

<!-- Modal Container -->
<div id="modal-container" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modal-title" class="text-xl font-bold">Add New Record</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="modal-form" method="POST" action="?page=feature&action=create">
            <input type="hidden" id="record-id" name="id">
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Field 1</label>
                <input type="text" id="field1" name="column1" required
                       class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Field 2</label>
                <input type="text" id="field2" name="column2" required
                       class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
            </div>
            
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeModal()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<!-- External JS at end of view -->
<script>
    window.ASSET_BASE_PATH = '<?= $basePath ?>';
</script>
<script src="<?= $asset('assets/js/feature.js'); ?>" defer></script>
```

```javascript
// In assets/js/feature.js
let currentMode = 'add'; // 'add', 'edit', 'view', 'delete'

function openModal(mode, data = null) {
    currentMode = mode;
    const modal = document.getElementById('modal-container');
    const overlay = document.getElementById('modal-overlay');
    const form = document.getElementById('modal-form');
    const title = document.getElementById('modal-title');
    
    // Show modal
    modal.classList.remove('hidden');
    overlay.classList.remove('hidden');
    
    // Configure based on mode
    if (mode === 'add') {
        title.textContent = 'Add New Record';
        form.action = '?page=feature&action=create';
        form.reset();
        document.getElementById('record-id').value = '';
    } else if (mode === 'edit' && data) {
        title.textContent = 'Edit Record';
        form.action = '?page=feature&action=update';
        document.getElementById('record-id').value = data.id;
        document.getElementById('field1').value = data.column1;
        document.getElementById('field2').value = data.column2;
    } else if (mode === 'view' && data) {
        title.textContent = 'View Record';
        document.getElementById('field1').value = data.column1;
        document.getElementById('field2').value = data.column2;
        // Disable inputs for view mode
        document.getElementById('field1').disabled = true;
        document.getElementById('field2').disabled = true;
    }
}

function closeModal() {
    const modal = document.getElementById('modal-container');
    const overlay = document.getElementById('modal-overlay');
    modal.classList.add('hidden');
    overlay.classList.add('hidden');
    
    // Re-enable inputs if they were disabled
    document.getElementById('field1').disabled = false;
    document.getElementById('field2').disabled = false;
}

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
});
```

### Template 3: Adding Pagination to List View
```php
// In Controller
public function index(): void {
    // Pagination setup
    $perPage = 10;
    $currentPage = isset($_GET['pg']) ? max(1, (int)$_GET['pg']) : 1;
    $offset = ($currentPage - 1) * $perPage;
    
    // Filters
    $filters = [
        'search' => $_GET['search'] ?? '',
        'status' => $_GET['status'] ?? '',
        'limit' => $perPage,
        'offset' => $offset
    ];
    
    // Fetch paginated data
    $records = $this->model->filter($filters);
    
    // Get total count (remove limit/offset for count)
    $countFilters = array_diff_key($filters, ['limit' => '', 'offset' => '']);
    $totalRecords = $this->model->countFiltered($countFilters);
    $totalPages = ceil($totalRecords / $perPage);
    
    // Pass to view
    $paginationData = [
        'currentPage' => $currentPage,
        'totalPages' => $totalPages,
        'totalRecords' => $totalRecords,
        'perPage' => $perPage
    ];
    
    require __DIR__ . '/../view/feature/index.php';
}

// In Model
public function filter(array $filters = []): array {
    $sql = "SELECT * FROM table_name WHERE 1=1";
    $params = [];
    
    if (!empty($filters['search'])) {
        $sql .= " AND (column1 LIKE ? OR column2 LIKE ?)";
        $params[] = '%' . $filters['search'] . '%';
        $params[] = '%' . $filters['search'] . '%';
    }
    
    if (!empty($filters['status'])) {
        $sql .= " AND status = ?";
        $params[] = $filters['status'];
    }
    
    $sql .= " ORDER BY created_at DESC";
    
    if (isset($filters['limit'])) {
        $sql .= " LIMIT ? OFFSET ?";
        $params[] = (int)$filters['limit'];
        $params[] = (int)$filters['offset'];
    }
    
    $stmt = $this->pdo->prepare($sql);
    $stmt->execute($params);
    return $stmt->fetchAll();
}

public function countFiltered(array $filters = []): int {
    $sql = "SELECT COUNT(*) FROM table_name WHERE 1=1";
    $params = [];
    
    if (!empty($filters['search'])) {
        $sql .= " AND (column1 LIKE ? OR column2 LIKE ?)";
        $params[] = '%' . $filters['search'] . '%';
        $params[] = '%' . $filters['search'] . '%';
    }
    
    if (!empty($filters['status'])) {
        $sql .= " AND status = ?";
        $params[] = $filters['status'];
    }
    
    $stmt = $this->pdo->prepare($sql);
    $stmt->execute($params);
    return (int)$stmt->fetchColumn();
}
```

```php
<!-- In View (after table) -->
<?php if (isset($paginationData) && $paginationData['totalPages'] > 1): ?>
    <div class="flex items-center justify-between px-4 py-3 border-t border-gray-200">
        <div>
            <p class="text-sm text-gray-700">
                Menampilkan <?= ($paginationData['currentPage'] - 1) * $paginationData['perPage'] + 1 ?>
                - <?= min($paginationData['currentPage'] * $paginationData['perPage'], $paginationData['totalRecords']) ?>
                dari <?= $paginationData['totalRecords'] ?> records
            </p>
        </div>
        <div class="flex gap-2">
            <?php if ($paginationData['currentPage'] > 1): ?>
                <a href="?page=feature&pg=<?= $paginationData['currentPage'] - 1 ?>&search=<?= $_GET['search'] ?? '' ?>&status=<?= $_GET['status'] ?? '' ?>"
                   class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Prev</a>
            <?php endif; ?>
            
            <?php 
            $range = 2;
            $startPage = max(1, $paginationData['currentPage'] - $range);
            $endPage = min($paginationData['totalPages'], $paginationData['currentPage'] + $range);
            
            for ($i = $startPage; $i <= $endPage; $i++): 
            ?>
                <a href="?page=feature&pg=<?= $i ?>&search=<?= $_GET['search'] ?? '' ?>&status=<?= $_GET['status'] ?? '' ?>"
                   class="px-3 py-1 <?= $i === $paginationData['currentPage'] ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300' ?> rounded">
                    <?= $i ?>
                </a>
            <?php endfor; ?>
            
            <?php if ($paginationData['currentPage'] < $paginationData['totalPages']): ?>
                <a href="?page=feature&pg=<?= $paginationData['currentPage'] + 1 ?>&search=<?= $_GET['search'] ?? '' ?>&status=<?= $_GET['status'] ?? '' ?>"
                   class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next</a>
            <?php endif; ?>
        </div>
    </div>
<?php endif; ?>
```

### Template 4: Implementing AJAX Endpoint
```php
// Step 1: Add Controller Method (controller/FeatureController.php)
public function getDataAjax(): void {
    header('Content-Type: application/json');
    
    try {
        // Validate request
        if (!isset($_GET['id'])) {
            echo json_encode([
                'success' => false,
                'message' => 'ID parameter required',
                'data' => null
            ]);
            exit;
        }
        
        $id = (int)$_GET['id'];
        
        // Fetch data from model
        $data = $this->model->getById($id);
        
        if ($data) {
            echo json_encode([
                'success' => true,
                'message' => 'Data retrieved successfully',
                'data' => $data
            ]);
        } else {
            echo json_encode([
                'success' => false,
                'message' => 'Data not found',
                'data' => null
            ]);
        }
    } catch (Exception $e) {
        echo json_encode([
            'success' => false,
            'message' => 'Server error: ' . $e->getMessage(),
            'data' => null
        ]);
    }
    exit;
}
```

```javascript
// Step 2: Implement Fetch in JS (assets/js/feature.js)

// Modern async/await pattern (recommended)
async function loadData(id) {
    const loadingIndicator = document.getElementById('loading');
    const errorContainer = document.getElementById('error');
    
    try {
        // Show loading state
        loadingIndicator.classList.remove('hidden');
        errorContainer.classList.add('hidden');
        
        // Make AJAX request
        const response = await fetch(`?page=feature&action=getDataAjax&id=${id}`);
        
        // Check if response is OK
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        // Handle response
        if (result.success) {
            displayData(result.data);
        } else {
            showError(result.message);
        }
    } catch (error) {
        console.error('Error loading data:', error);
        showError('Failed to load data. Please try again.');
    } finally {
        // Hide loading state
        loadingIndicator.classList.add('hidden');
    }
}

// Alternative: Promise-based pattern
function loadDataPromise(id) {
    const loadingIndicator = document.getElementById('loading');
    
    loadingIndicator.classList.remove('hidden');
    
    fetch(`?page=feature&action=getDataAjax&id=${id}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                displayData(result.data);
            } else {
                showError(result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to load data. Please try again.');
        })
        .finally(() => {
            loadingIndicator.classList.add('hidden');
        });
}

// Helper functions
function displayData(data) {
    const container = document.getElementById('data-container');
    container.innerHTML = `
        <div class="data-item">
            <h3>${data.title}</h3>
            <p>${data.description}</p>
        </div>
    `;
}

function showError(message) {
    const errorContainer = document.getElementById('error');
    errorContainer.textContent = message;
    errorContainer.classList.remove('hidden');
}

// POST request example with form data
async function submitFormAjax(formData) {
    try {
        const response = await fetch('?page=feature&action=submitAjax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Success: ' + result.message);
            // Optionally reload data or update UI
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to submit form. Please try again.');
    }
}
```

```html
<!-- Step 3: HTML Structure with Loading States -->
<div id="data-container">
    <!-- Data will be loaded here -->
</div>

<!-- Loading indicator -->
<div id="loading" class="hidden flex items-center justify-center p-4">
    <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span class="ml-2">Loading...</span>
</div>

<!-- Error container -->
<div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
    <!-- Error message will appear here -->
</div>
```

## Key Examples
**Route with action:** `/index.php?page=booking&action=buat_booking`  
**Admin route:** `/index.php?page=admin&action=member_list`  
**Super Admin only:** `/index.php?page=admin&action=booking_external`  
**Asset reference:** `<img src="<?= $asset('/assets/image/logo.png') ?>">`  
**Role check in view:** `<?php if ($_SESSION['user']['role'] === 'Super Admin'): ?>`  
**DB query with prepared statement:** `$stmt = $pdo->prepare("SELECT * FROM ruangan WHERE status_ruangan = ?"); $stmt->execute(['Tersedia']); $rooms = $stmt->fetchAll();`  
**AJAX request:** `fetch('?page=booking&action=get_user_by_nim&nim=123').then(r => r.json()).then(data => console.log(data.success ? data.data : data.message));`  
**AJAX with async/await:** `async function loadData() { try { const response = await fetch(url); const data = await response.json(); handleData(data); } catch (error) { console.error(error); } }`  
**Transaction pattern:** `$this->pdo->beginTransaction(); try { /* queries */ $this->pdo->commit(); } catch (Exception $e) { $this->pdo->rollBack(); return false; }`  
**Logout:** `assets/js/auth.js` listens for `#btn-logout` â†’ redirects to `index.php?page=login&action=logout`

## Troubleshooting Common Issues

**404 Error on new route:**
- Check `$mapmodeldancontroller` array in `index.php` has controller/model mappings
- Verify `switch ($halaman)` case exists with proper controller instantiation
- **CRITICAL:** Ensure `break;` statement exists after each case (missing break causes fallthrough to default/home)

**Styles not applying:**
- Run `npm run build:css` to regenerate `assets/css/main.css`
- Check browser console for 404 errors on `main.css`
- Verify `view/components/head.php` is included at top of view file

**Database connection failed:**
- Verify MySQL service running in XAMPP control panel
- Check credentials in `config/Koneksi.php` match your environment
- Ensure database `PBL-Perpustakaan` exists (import `sql/database.sql` if needed)

**Session/auth issues:**
- Check `session_start()` is called before output (handled globally in `index.php`)
- Verify `$_SESSION['user']` contains expected keys after login
- Clear browser cookies if session seems stuck

**CAPTCHA not displaying:**
- Ensure GD extension enabled in PHP (`extension=gd` in `php.ini`)
- Check `view/components/captcha.php` accessible via browser directly
- Verify `$_SESSION['code']` is set when captcha generated

**Auto-update methods not working:**
- Verify `autoUpdateHangusStatus()` and `autoUpdateRoomStatus()` called at controller entry points
- Check system time matches expected timezone for booking time comparisons
- Review database datetime columns format (should be `YYYY-MM-DD HH:MM:SS`)

**File upload failures:**
- Check directory permissions on `assets/uploads/` folders (should be writable)
- Verify file size within PHP limits (`upload_max_filesize` and `post_max_size` in `php.ini`)
- Ensure MIME type validation matches actual file type (use `finfo_file()` not file extension)
